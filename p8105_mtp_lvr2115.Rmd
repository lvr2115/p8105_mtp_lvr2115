---
title: "p8105_mtp_lvr2115"
author: "Laura Robles-Torres"
date: "2023-10-18"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
library(tidyverse)
library(dplyr)
```

# Introduction
The data are from Change of Address (COAs) forms received by the United States Post Office in New York City between 2018 and 2022. They include the total number of COAs to and from each NYC zip code for each month of those 5 years.  These COAs are filed by people who are moving to ensure that mail is delivered to their new address.

## Problem-1

Given that in some cases the borough name and the county name differ, a dataset with neighborhood data called `zipcodes` is imported to clarify. A new variable `borough` is created in this dataset to accurately reflect the borough each zipcode is located in. 

```{r import and tidy zipcodes, warning=FALSE}
zipcodes = 
  read_csv("./zip codes.csv") |> #import dataset
  janitor::clean_names() |> #clean var names
  mutate(
    borough = recode(county_name, 
                     "Bronx" = "The Bronx",
                     "Kings" = "Brooklyn",
                     "New York" = "Manhattan",
                     "Richmond" = "Staten Island") #create borough var based on county
)
```

Each sheet containing COA data from each year is exported and variable names cleaned before being combined. Variables `total_perm_in` and `total_perm_out`indicate the total number of permanent address changes going into and out of each zip code, respectively. 

```{r import and tidy COAs}
coa_2018 = 
  readxl::read_excel("./USPS CHANGE OF ADDRESS NYC.xlsx", sheet = "2018") |> #import dataset
  janitor::clean_names() #clean var names
  
coa_2019 = 
  readxl::read_excel("./USPS CHANGE OF ADDRESS NYC.xlsx", sheet = "2019") |> #import dataset
  janitor::clean_names()  #clean var names
   
coa_2020 = 
  readxl::read_excel("./USPS CHANGE OF ADDRESS NYC.xlsx", sheet = "2020") |> #import dataset
  janitor::clean_names() #clean var names

coa_2021 = 
  readxl::read_excel("./USPS CHANGE OF ADDRESS NYC.xlsx", sheet = "2021") |> #import dataset
  janitor::clean_names() #clean var names

coa_2022 = 
  readxl::read_excel("./USPS CHANGE OF ADDRESS NYC.xlsx", sheet = "2022") |> #import dataset
  janitor::clean_names() #clean var names
```

A new variable called `net_change`is created in each annual dataset that subtracts each `total_perm_out` from each `total_perm_in` value to reflect the increase or decrease in COAs that month and year. `month_num` is renamed as `month`, recoded as a factor variable and replaced with month names. Variable `year` is created by separating `month` into year, name of month, and day. Then, all of the annual datasets for COAs data from years 2018 and 2022 were bound together using `bind_rows` into a dataset called `combined_coa`. `zipcode` was re-named to `zip_code` to match `zipcodes` and allow for merging. 

```{r combine COAs }
combined_coa =
	bind_rows(coa_2018, coa_2019, coa_2020,coa_2021,coa_2022) |> 
  separate(month, into = c("year", "month_num", "day"), convert = TRUE) |> #create year variable
  rename(month = month_num) |> #rename month 
  rename("zip_code"="zipcode") |> #rename zipcode
  mutate(
  net_change = total_perm_in - total_perm_out, #Create net_change var 
  month = case_match(month, #rename month variable with month names
      1 ~ "January",
      2 ~ "February",
      3 ~ "March",
      4 ~ "April",
      5 ~ "May",
      6 ~ "June",
      7 ~ "July",
      8 ~ "August",
      9 ~ "September",
      10 ~ "October",
      11 ~ "November",
      12 ~ "December"),
  month = as.factor(month) #recode as factor variable
) 
```

Merging  `combined_coa` with  `zipcodes`

```{r merge COA with zipcode data}
merged_coazips = 
  inner_join(zipcodes, combined_coa, by="zip_code") |> #merge COA with zipcode datasets 
  select(everything(), -county_name, -state_fips, -file_date, -day, -starts_with("county")) 

str(merged_coazips) 
```

The final tidy dataset  `merged_coazips` has `r nrow(merged_coazips)` observations and `r ncol(merged_coazips)` variables and tells us about the net change in COAs for a given year from years 2018 to 2022. 

In the merged dataset total, there are `r merged_coazips |> select(zip_code) |> distinct() |> count()` zipcodes found and  `r merged_coazips |> select(neighborhood) |> distinct() |> count()` unique neighborhoods. 

### This table shows the most common cities represented in the data from Manhattan. 

```{r}
merged_coazips |> 
  filter(borough %in% c("Manhattan")) |>
  count(city) |> 
  mutate(rank = min_rank(desc(n))) |> 
  arrange(desc(n)) |>
  slice(1:6) |>
  knitr::kable()
```

Manhattan is in New York City and everyone who selected Manhattan should have New York as its city. While its the most common city, 60 and 59 COAs have Bronx and Brookyln respectively as their city within Manhattan, which is not accurate. 

### This table shows the most common cities represented in the data from Queens.

```{r}
merged_coazips |> 
  filter(borough %in% c("Queens")) |>
  count(city) |> 
  mutate(rank = min_rank(desc(n))) |> 
  arrange(desc(n)) |>
  slice(1:5) |>
  knitr::kable()
```
 
Jamaica, Flushing, and Astoria are the top 3 cities represented in Brookyln COAs. These are all neighborhoods within the borough, not cities, and are not accurate data points.

There are 60 months between 2018 and 2022, but many ZIP codes have fewer than 60 observations; most of these are also missing neighborhood values. Discuss why this might be the case, using a few concrete examples as illustration. 

## Problem-2

This table shows the average change in COAs in each borough and year. Across all boroughs, except Staten Island, the absolute average change in COAs is the highest in 2020, showing the increase in people moving out of NYC in 2020 during the COVID-19 pandemic.

```{r}
merged_coazips |>
  group_by(borough, year) |>
  summarize(mean_net_change = mean(net_change)) |>
  pivot_wider(
    names_from = year,
    values_from = mean_net_change
  ) |>
  knitr::kable(digits = 2)
```

This table shows the five lowest values of average change in COAs and they are all negative values. The zipcodes are all in the neighborhoods Gramercy Park/Murray Hill and the Lower East Side. These experienced the highest number of move-outs relative to move-ins. These are all in the immediate aftermath of the onset of the COVID-19 pandemic between May-July 2020.  

```{r}
merged_coazips |>
  arrange(net_change) |>
  slice(1:5) |>
  select(zip_code, neighborhood, month, year, net_change) |>
  knitr::kable()
```

This table shows the five highest values of average change in COAs before 2020, showing neighborhoods that experienced the most move-ins relative to move-outs. These highest values are in April-July 2018 and range from neighborhoods in Queens, Manhattan and Brookyln. 

```{r}
merged_coazips |>
  filter(year < 2020) |>
  arrange(desc(net_change)) |>
  slice(1:5) |>
  select(zip_code, neighborhood, month, year, net_change) |>
  knitr::kable()
```

This plot shows neighborhood-level average net_change values against month over all five years. Your plot should facilitate comparisons across boroughs.

```{r}
neighborhood_avg =
  merged_coazips |> 
  group_by(borough, neighborhood, month) |> 
  summarize(avg_net_change = mean(net_change, na.rm = TRUE))

neighborhood_avg |> 
  ggplot(aes(x = month, y = avg_net_change, color = borough)) + 
  geom_line() +
  labs(x = "Month", y = "Average Net Change", title = "Neighborhood-Level Average Net Change Over Time") +
  theme(axis.text.x = element_text(angle=90, vjust=0.5, hjust=1)) 
```
