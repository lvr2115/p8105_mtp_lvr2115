---
title: "p8105_mtp_lvr2115"
author: "Laura Robles-Torres"
date: "2023-10-18"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
```

# Introduction
The data being imported and cleaned are from Change of Address (COAs) forms received by the United States Post Office in New York City between 2018 and 2022. They include the total number of COAs to and from each NYC zip code for each month of those 5 years.  These COAs are filed by people who are moving to ensure that mail is delivered to their new address. There is another dataset being worked on that includes zipcode, neighborhood, and county data for New York City. 

## Problem 1

Given that in some cases the borough name and the county name differ, a dataset with neighborhood data called `zipcodes` is imported and tidied. A new variable `borough` is created in this dataset to accurately reflect where borough each zipcode is located in. 

```{r import and tidy zipcodes, warning=FALSE}
zipcodes = 
  read_csv("./zip codes.csv") |> #import dataset
  janitor::clean_names() |> #clean var names
  mutate(
    borough = recode(county_name, 
                     "Bronx" = "The Bronx",
                     "Kings" = "Brooklyn",
                     "New York" = "Manhattan",
                     "Richmond" = "Staten Island") #create borough var based on county
)
```

Given that the data from COAs for each year is in a different Excel sheet, each sheet is exported and cleaned before being combined via `bind_rows` into a dataset called `combined_coa`. Variables `total_perm_in` and `total_perm_out`indicate the total number of permanent address changes going into and out of each zip code, respectively. A new variable called `net_change`is created in each annual dataset that subtracts each `total_perm_out` from each `total_perm_in` value to reflect the increase or decrease in COAs that month and year. Additionally, a `year` variable is created by separating `month` into year, number of the corresponding month, and day. 

```{r import and tidy COAs}
coa_2018 = 
  readxl::read_excel("./USPS CHANGE OF ADDRESS NYC.xlsx", sheet = "2018") |> #import dataset
  janitor::clean_names() |> #clean var names
  separate(month, into = c("year", "month_num", "day"), convert = TRUE) |> #create year var
   mutate(
    net_change = total_perm_in - total_perm_out) #Create net_change var 

coa_2019 = 
  readxl::read_excel("./USPS CHANGE OF ADDRESS NYC.xlsx", sheet = "2019") |> #import dataset
  janitor::clean_names() |> #clean var names
  separate(month, into = c("year", "month_num", "day"), convert = TRUE) |> #create year var
   mutate(
    net_change = total_perm_in - total_perm_out) #Create net_change var 

coa_2020 = 
  readxl::read_excel("./USPS CHANGE OF ADDRESS NYC.xlsx", sheet = "2020") |> #import dataset
  janitor::clean_names() |> #clean var names
  separate(month, into = c("year", "month_num", "day"), convert = TRUE) |> #create year var
   mutate(
    net_change = total_perm_in - total_perm_out) #Create net_change var 

coa_2021 = 
  readxl::read_excel("./USPS CHANGE OF ADDRESS NYC.xlsx", sheet = "2021") |> #import dataset
  janitor::clean_names() |> #clean var names
  separate(month, into = c("year", "month_num", "day"), convert = TRUE) |> #create year var
   mutate(
    net_change = total_perm_in - total_perm_out) #Create net_change var 

coa_2022 = 
  readxl::read_excel("./USPS CHANGE OF ADDRESS NYC.xlsx", sheet = "2022") |> #import dataset
  janitor::clean_names() |> #clean var names
  separate(month, into = c("year", "month_num", "day"), convert = TRUE) |> #create year var
   mutate(
    net_change = total_perm_in - total_perm_out) #Create net_change var 
```

Then, all of the annual datasets for COAs data from years 2018 and 2022 were bound together and the variable `zipcode` was re-named to `zip_code` to match `zipcodes` and allow for merging. 

```{r combine COAs }
combined_coa =
	bind_rows(coa_2018, coa_2019, coa_2020,coa_2021,coa_2022) |>
  rename("zip_code"="zipcode") #combine COA data from all sheets belonging to different years
```

Merging  `combined_coa` with  `zipcodes`:

```{r merge COA with zipcode data}
merged_coazips = 
  left_join(zipcodes, combined_coa, by="zip_code") |> #merge COA with zipcode datasets 
  select(everything(), -county_name, -state_fips, -file_date, -day, -starts_with("county")) 

str(merged_coazips) 
```

The final tidy dataset  `merged_coazips` has `r nrow(merged_coazips)` observations and `r ncol(merged_coazips)` variables and tells us about the net change in COAs for a given year from years 2018 to 2022. 

In the merged dataset total, there are `r merged_coazips |> select(zip_code) |> distinct() |> count()` zipcodes found and  `r merged_coazips |> select(neighborhood) |> distinct() |> count()` unique neighborhoods. 

This table shows the most common values of city in the borough of Manhattan.

```{r}
merged_coazips |> 
  filter(borough %in% c("Manhattan")) |>
  group_by(borough) |> 
  count(city) |> 
  mutate(rank = min_rank(desc(n))) |> 
  arrange(desc(n)) |>
  knitr::kable()
```

This table shows the most common values of city in the borough of Queens.

```{r}
merged_coazips |> 
  filter(borough %in% c("Queens")) |>
  group_by(borough) |> 
  count(city) |> 
  mutate(rank = min_rank(desc(n))) |> 
  arrange(desc(n)) |>
  knitr::kable()
```

There are 60 months between 2018 and 2022, but many ZIP codes have fewer than 60 observations; most of these are also missing neighborhood values. Discuss why this might be the case, using a few concrete examples as illustration. 

## Problem 2

This table shows the average of net_change in each borough and year. 

```{r}
merged_coazips |>
  group_by(year, borough) |>
  summarize(mean_net_change = mean(net_change)) |>
  knitr::kable(digits = 2)
```

This table shows, across all observed data, the five lowest values of net_change. This table should include ZIP code, neighborhood, and the year and month.
```{r}
merged_coazips |>
  group_by(zip_code) |>
  filter(min_rank(net_change) < 6) |>
  arrange(net_change) |>
  knitr::kable()
```

This table shows, across data observed before 2020, the five highest values of net_change. This table should include ZIP code, neighborhood, and the year and month.

```{r}
merged_coazips |>
  filter(year < 2020) |>
  group_by(net_change, zip_code) |>
  arrange(desc(net_change)) |>
  knitr::kable()
```

This plot shows neighborhood-level average net_change values (i.e. averaging across ZIP codes within neighborhoods) against month over all five years. Your plot should facilitate comparisons across boroughs.

```{r}
merged_coazips |>
  group_by(neighborhood) |>
  mutate(
    mean_netchange = mean(net_change, na.rm = TRUE)) |> 
  ggplot(aes(x = month_num, y = mean_netchange, color = borough)) +
  geom_point()
```

