---
title: "p8105_mtp_lvr2115"
author: "Laura Robles-Torres"
date: "2023-10-18"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
```

# Introduction

##Problem 1

### These data are from Change of Address (COAs) forms received by the United States Post Office in New York City between 2018 and 2022. It includes the total number of COAs to and from each NYC zip code for each month of those 5 years.  These COAs are filed by people who are moving to ensure that mail is delivered to their new address.

In each sheet, the TOTAL PERM IN and TOTAL PERM OUT indicate the total number of permanent address changes going into and out of each ZIP code.

NYC is divided into five boroughs. Each of these boroughs is it’s own county, and in some cases the borough name and county name differ; for example, Manhattan is New York County. Moreover, boroughs are divided into neighborhoods. COA data provided by USPS may not accurately reflect NYC’s counties, boroughs, and neighborhoods, and a supplementary dataset including these is available here.

```{r import and tidy zipcodes, warning=FALSE}
zipcodes = 
  read_csv("./zip codes.csv") |> #import dataset
  janitor::clean_names() |> #clean var names
  mutate(
    borough = recode(county_name, 
                     "Bronx" = "The Bronx",
                     "Kings" = "Brooklyn",
                     "New York" = "Manhattan",
                     "Richmond" = "Staten Island") #create borough var based on county
)
```

```{r import and tidy COAs}
coa_2018 = 
  readxl::read_excel("./USPS CHANGE OF ADDRESS NYC.xlsx", sheet = "2018") |> #import dataset
  janitor::clean_names() |> #clean var names
  separate(month, into = c("year", "month_num", "day"), convert = TRUE) |> #create year var
   mutate(
    net_change = total_perm_in - total_perm_out) #Create net_change var 

coa_2019 = 
  readxl::read_excel("./USPS CHANGE OF ADDRESS NYC.xlsx", sheet = "2019") |> #import dataset
  janitor::clean_names() |> #clean var names
  separate(month, into = c("year", "month_num", "day"), convert = TRUE) |> #create year var
   mutate(
    net_change = total_perm_in - total_perm_out) #Create net_change var 

coa_2020 = 
  readxl::read_excel("./USPS CHANGE OF ADDRESS NYC.xlsx", sheet = "2020") |> #import dataset
  janitor::clean_names() |> #clean var names
  separate(month, into = c("year", "month_num", "day"), convert = TRUE) |> #create year var
   mutate(
    net_change = total_perm_in - total_perm_out) #Create net_change var 

coa_2021 = 
  readxl::read_excel("./USPS CHANGE OF ADDRESS NYC.xlsx", sheet = "2021") |> #import dataset
  janitor::clean_names() |> #clean var names
  separate(month, into = c("year", "month_num", "day"), convert = TRUE) |> #create year var
   mutate(
    net_change = total_perm_in - total_perm_out) #Create net_change var 

coa_2022 = 
  readxl::read_excel("./USPS CHANGE OF ADDRESS NYC.xlsx", sheet = "2022") |> #import dataset
  janitor::clean_names() |> #clean var names
  separate(month, into = c("year", "month_num", "day"), convert = TRUE) |> #create year var
   mutate(
    net_change = total_perm_in - total_perm_out) #Create net_change var 
```

```{r combine COAs }
combined_coa =
	bind_rows(coa_2018, coa_2019, coa_2020,coa_2021,coa_2022) |>
  rename("zip_code"="zipcode") |> #combine COA data from all sheets belonging to different years

```

```{r merge COA with zipcode data}
merged_coazips = 
  left_join(zipcodes, combined_coa, by="zip_code") |> #merge COA with zipcode datasets 
  select(everything(), -county_name, -state_fips, -file_date, -day, -starts_with("county")) 

str(merged_coazips) 
```

The combined COA dataset  `combined_coa` has `r nrow(combined_coa)` observations and `r ncol(combined_coa)` variables and tells us about the total perm in and total perm out and net change in COAs for a given year from years `r combined_coa |> pull(year) |> min()` to `r combined_coa |> pull(year) |> max()`. 

In the merged dataset total, there are `r merged_coazips |> select(zip_code) |> distinct() |> count()` zipcodes found and  `r merged_coazips |> select(neighborhood) |> distinct() |> count()` unique neighborhoods. 

This table shows the most common values of city in the borough of Manhattan.

```{r}
merged_coazips |> 
  filter(borough %in% c("Manhattan")) |>
  group_by(borough) |> 
  count(city) |> 
  mutate(rank = min_rank(desc(n))) |> 
  arrange(desc(n)) |>
  knitr::kable()
```

This table shows the most common values of city in the borough of Queens.

```{r}
merged_coazips |> 
  filter(borough %in% c("Queens")) |>
  group_by(borough) |> 
  count(city) |> 
  mutate(rank = min_rank(desc(n))) |> 
  arrange(desc(n)) |>
  knitr::kable()
```

There are 60 months between 2018 and 2022, but many ZIP codes have fewer than 60 observations; most of these are also missing neighborhood values. Discuss why this might be the case, using a few concrete examples as illustration. 

##Problem 2

This table shows the average of net_change in each borough and year. 

```{r}
merged_coazips |>
  group_by(year, borough) |>
  summarize(mean_net_change = mean(net_change)) |>
  knitr::kable(digits = 2)
```

This table shows, across all observed data, the five lowest values of net_change. This table should include ZIP code, neighborhood, and the year and month.
```{r}
merged_coazips |>
  group_by(zip_code) |>
  filter(min_rank(net_change) < 6) |>
  arrange(net_change) |>
  knitr::kable()
```

This table shows, across data observed before 2020, the five highest values of net_change. This table should include ZIP code, neighborhood, and the year and month.

```{r}
merged_coazips |>
  filter(year < 2020) |>
  group_by(net_change, zip_code) |>
  arrange(desc(net_change)) |>
  knitr::kable()
```
This plot shows neighborhood-level average net_change values (i.e. averaging across ZIP codes within neighborhoods) against month over all five years. Your plot should facilitate comparisons across boroughs.

```{r}
merged_coazips |>
  group_by(neighborhood) |>
  mutate(
    mean_netchange = mean(net_change, na.rm = TRUE)) |> 
  ggplot(aes(x = month_num, y = centered_netchange, color = borough)) 
```

